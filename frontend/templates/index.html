<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Баланс | Трекер финансов</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="../static/style_index.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<!-- Боковое меню -->
<div class="side-menu">
  <div class="menu-item" title="Добавить операцию" id="addOperationBtn">
    <img src="../media/plus.png" alt="" />
  </div>
  <div class="menu-item active" title="Дом">
    <img src="../media/home.png" alt="" />
  </div>
  <a href="history.html"> <div class="menu-item" title="История">
    <img src="../media/history.png" alt="" />
  </div></a>
  <a href="#" onclick="logout(); return false;">
    <div class="menu-item" title="Выход">
      <img src="../media/exit.png" alt="" />
    </div>
  </a>
</div>

<div class="container">
  <div class="balance-header">
    <h1 class="balance-title">Баланс</h1>
  </div>

  <div class="balance-amount balance-positive" id="balanceAmount">786 345,96 ₽</div>

  <!-- Комбинированный график сверху -->
  <div class="main-chart-container">
    <div class="chart-box combined-chart">
      <div class="chart-title">Доходы и расходы</div>
      <div class="chart-wrapper">
        <canvas id="combinedChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Круговые диаграммы рядом -->
  <div class="pie-charts-container">
    <div class="chart-box">
      <div class="chart-title">Доходы по категориям</div>
      <div class="chart-wrapper">
        <canvas id="incomeChart"></canvas>
      </div>
      <div class="pie-period-selector">
        <button class="pie-period-btn" data-period="day">День</button>
        <button class="pie-period-btn active" data-period="week">Неделя</button>
        <button class="pie-period-btn" data-period="month">Месяц</button>
      </div>
    </div>

    <div class="chart-box">
      <div class="chart-title">Расходы по категориям</div>
      <div class="chart-wrapper">
        <canvas id="expenseChart"></canvas>
      </div>
      <div class="pie-period-selector">
        <button class="pie-period-btn" data-period="day">День</button>
        <button class="pie-period-btn active" data-period="week">Неделя</button>
        <button class="pie-period-btn" data-period="month">Месяц</button>
      </div>
    </div>
  </div>

  <div class="categories">
    <div class="category-section">
      <h2 class="category-title">ДОХОД</h2>
      <ul class="category-list" id="incomeCategories">

      </ul>
    </div>

    <div class="category-section">
      <h2 class="category-title">РАСХОД</h2>
      <ul class="category-list" id="expenseCategories">

      </ul>
    </div>
  </div>
</div>

<!-- Модальное окно для добавления операций -->
<div class="modal" id="operationModal">
  <div class="modal-content">
    <span class="close">&times;</span>

    <div class="tabs">
      <div class="tab" data-tab="income">Доход</div>
      <div class="tab active" data-tab="expense">Расход</div>
    </div>

    <input type="number" class="amount-input" id="operationAmount" placeholder="Введите сумму">

    <div class="modal-categories" id="modalCategories">
      <!-- Категории будут подгружаться -->
    </div>

    <button class="submit-btn" id="submitOperation">Отправить</button>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Получаем токен только из куки
    const token = document.cookie
            .split('; ')
            .find(row => row.startsWith('USER_JWT='))
            ?.split('=')[1];

    if (!token) {
      window.location.href = 'enter.html'; // Перенаправляем на страницу входа
      return; // Прерываем выполнение
    }
  });
  $(document).ready(function() {
    initCharts();
    loadBalance();
    loadCategoriesMain('income');
    loadCategoriesMain('expense');
    setupEventListeners();
  });
  // Конфигурация
  const MOCK_MODE = false; // Режим моковых данных (true-используются моковые данные)
  const API_BASE_URL = 'http://localhost:8080/api/v1'; // позже поменять

  // Моковые данные
  const MOCK_DATA = {
    balance: {
      amount: 786345.96,
      change: 10000
    },
    categories: {
      income: [
        { id: 1, name: "Вклад", amount: 45000, color: "#FFF8A5" },
        { id: 2, name: "Бизнес", amount: 32000, color: "#A7BDEE" },
        { id: 3, name: "Зарплата", amount: 120000, color: "#81E472" },
        { id: 4, name: "Аренда", amount: 25000, color: "#D6A7EE" },
        { id: 5, name: "Криптовалюта", amount: 8500, color: "#EEA7A8" },
        { id: 6, name: "Другие", amount: 5200, color: "#4C5BCF" }
      ],
      expense: [
        { id: 101, name: "Дом", amount: 35000, color: "#E2A7EE" },
        { id: 102, name: "Продукты", amount: 18000, color: "#B3EEA7" },
        { id: 103, name: "Хобби", amount: 12000, color: "#EEA7A8" },
        { id: 104, name: "Кафе", amount: 8500, color: "#EEC6A7" },
        { id: 105, name: "Здоровье", amount: 6200, color: "#A7ECEE" },
        { id: 106, name: "Другие", amount: 4300, color: "#EEEDA7" }
      ]
    },
    statistics: {
      week: {
        combined: {
          labels: ["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"],
          income: [15000, 18000, 12000, 20000, 25000, 5000, 8000],
          expense: [8000, 9500, 6000, 12000, 15000, 12000, 5000]
        },
        income: {
          labels: ["Вклад", "Бизнес", "Зарплата", "Аренда", "Криптовалюта", "Другое"],
          data: [45000, 32000, 120000, 25000, 8500, 5200],
          colors: ["#FFF8A5", "#A7BDEE", "#81E472", "#D6A7EE", "#EEA7A8", "#4C5BCF"]
        },
        expense: {
          labels: ["Дом", "Продукты", "Хобби", "Кафе", "Здоровье", "Другое"],
          data: [35000, 18000, 12000, 8500, 6200, 4300],
          colors: ["#E2A7EE", "#B3EEA7", "#EEA7A8", "#EEC6A7", "#A7ECEE", "#EEEDA7"]
        }
      },
      month: {
        combined: {
          labels: ["Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"],
          income: [85000, 92000, 105000, 88000, 115000, 125000, 95000, 110000, 105000, 120000, 115000, 130000],
          expense: [45000, 50000, 55000, 48000, 52000, 60000, 65000, 58000, 62000, 70000, 68000, 75000]
        },
        income: {
          labels: ["Вклад", "Бизнес", "Зарплата", "Аренда", "Криптовалюта", "Другое"],
          data: [180000, 128000, 480000, 100000, 34000, 20800],
          colors: ["#FFF8A5", "#A7BDEE", "#81E472", "#D6A7EE", "#EEA7A8", "#4C5BCF"]
        },
        expense: {
          labels: ["Дом", "Продукты", "Хобби", "Кафе", "Здоровье", "Другое"],
          data: [140000, 72000, 48000, 34000, 24800, 17200],
          colors: ["#E2A7EE", "#B3EEA7", "#EEA7A8", "#EEC6A7", "#A7ECEE", "#EEEDA7"]
        }
      },
      day: {
        income: {
          labels: ["Вклад", "Бизнес", "Зарплата", "Аренда", "Криптовалюта", "Другое"],
          data: [5000, 2000, 30000, 5000, 1000, 800],
          colors: ["#FFF8A5", "#A7BDEE", "#81E472", "#D6A7EE", "#EEA7A8", "#4C5BCF"]
        },
        expense: {
          labels: ["Дом", "Продукты", "Хобби", "Кафе", "Здоровье", "Другое"],
          data: [2000, 1500, 800, 1200, 500, 300],
          colors: ["#E2A7EE", "#B3EEA7", "#EEA7A8", "#EEC6A7", "#A7ECEE", "#EEEDA7"]
        }
      }
    }
  };

  const AppState = {
    currentPeriod: 'week',
    charts: {
      combined: null,
      income: null,
      expense: null
    }
  };

  // Инициализация при загрузке

  // Инициализация графиков
  function initCharts() {
    AppState.charts.combined = new Chart(
            document.getElementById('combinedChart').getContext('2d'),
            {
              type: 'bar',
              data: {
                labels: MOCK_DATA.statistics.month.combined.labels,
                datasets: [
                  {
                    label: 'Доходы',
                    backgroundColor: '#91fabb',
                    borderColor: '#85bf97',
                    borderWidth: 1,
                    borderRadius: 5,
                    data: MOCK_DATA.statistics.month.combined.income
                  },
                  {
                    label: 'Расходы',
                    backgroundColor: '#ff6b62',
                    borderColor: '#c85a50',
                    borderWidth: 1,
                    borderRadius: 5,
                    data: MOCK_DATA.statistics.month.combined.expense
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'top',
                    labels: {
                      font: {
                        family: 'Manrope',
                        size: 14,
                        weight: 500
                      },
                      padding: 20,
                      usePointStyle: true,
                    }
                  },
                  tooltip: {
                    bodyFont: {
                      family: 'Manrope',
                      size: 14,
                      weight: 400
                    },
                    titleFont: {
                      family: 'Manrope',
                      size: 16,
                      weight: 600
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                      font: {
                        family: 'Manrope',
                        size: 12,
                        weight: 500
                      }
                    }
                  },
                  x: {
                    grid: {
                      display: false
                    },
                    ticks: {
                      font: {
                        family: 'Manrope',
                        size: 14,
                        weight: 500
                      }
                    }
                  }
                }
              }
            }
    );

    AppState.charts.income = new Chart(
            document.getElementById('incomeChart').getContext('2d'),
            {
              type: "doughnut",
              data: {
                labels: MOCK_DATA.statistics.week.income.labels,
                datasets: [{
                  data: MOCK_DATA.statistics.week.income.data,
                  backgroundColor: MOCK_DATA.statistics.week.income.colors,
                  borderWidth: 1,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "bottom",
                    labels: {
                      font: {
                        family: "Manrope",
                        size: 12,
                        weight: 500,
                      },
                      padding: 20,
                      usePointStyle: true,
                      pointStyle: "circle",
                    },
                  },
                },
                cutout: "70%",
              }
            }
    );

    AppState.charts.expense = new Chart(
            document.getElementById('expenseChart').getContext('2d'),
            {
              type: "doughnut",
              data: {
                labels: MOCK_DATA.statistics.week.expense.labels,
                datasets: [{
                  data: MOCK_DATA.statistics.week.expense.data,
                  backgroundColor: MOCK_DATA.statistics.week.expense.colors,
                  borderWidth: 1,
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: "bottom",
                    labels: {
                      font: {
                        family: "Manrope",
                        size: 12,
                        weight: 500,
                      },
                      padding: 20,
                      usePointStyle: true,
                      pointStyle: "circle",
                    },
                  },
                },
                cutout: "70%",
              }
            }
    );
  }

  // Загрузка данных
  function loadBalance() {
    $('#balanceAmount').text('Загрузка...');
    fetchBalance()
            .then(balance => {
              updateBalance(balance);
            })
            .catch(error => {
              console.error('Ошибка загрузки баланса:', error);
              $('#balanceAmount').text('Ошибка загрузки');
              if (MOCK_MODE) updateBalance(MOCK_DATA.balance);
            });
  }
  function loadCategoriesMain(type) {
    fetchCategories(type)
            .then(categories => {
              if (type === 'income') {
                updateIncomeCategories(categories);
              } else if (type === 'expense') {
                updateExpenseCategories(categories);
              }
            })
            .catch(error => {
              console.error(`Ошибка загрузки категорий (${type}):`, error);
              if (type === 'income') updateIncomeCategories(MOCK_DATA.categories.income);
              else if (type === 'expense') updateExpenseCategories(MOCK_DATA.categories.expense);
            });

  }
  function updateIncomeCategories(categories) {
    let incomeHtml = '';
    categories.forEach(cat => {
      incomeHtml += `
      <li class="category-item">
        ${cat.name} <span>${cat.amount.toLocaleString('ru-RU')} ₽</span>
      </li>`;
    });
    $('#incomeCategories').html(incomeHtml);
  }

  // Обновление UI для расходов
  function updateExpenseCategories(categories) {
    let expenseHtml = '';
    categories.forEach(cat => {
      expenseHtml += `
      <li class="category-item">
        ${cat.name} <span>${cat.amount.toLocaleString('ru-RU')} ₽</span>
      </li>`;
    });
    $('#expenseCategories').html(expenseHtml);
  }



  // API функции
  function fetchBalance() {
    const token = getToken();
    if (!token) {
      console.error("Токен не найден");
      window.location.href = 'enter.html';
      return Promise.reject('Token not found');
    }

    return $.ajax({
      url: `${API_BASE_URL}/transaction/index`,
      type: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    }).then(response => {
      console.log("Получен баланс:", response);
      // Возвращаем объект с полем amount, используя значение balance из ответа
      return { amount: response.balance };
    }).catch(error => {
      console.error('Ошибка при получении баланса:', error);
      throw error; // Пробрасываем ошибку дальше
    });
  }

  function fetchCategories(type) {
    const typeParam = type.toUpperCase();
    if (MOCK_MODE) return Promise.resolve(MOCK_DATA.categories[type]);
    return $.get(`${API_BASE_URL}/categories?categoryType=${typeParam}`).then(response => response);
  }

  function getToken() {
    const token = document.cookie
            .split('; ')
            .find(row => row.startsWith('USER_JWT='))
            ?.split('=')[1];
    return token;
  }

  function postOperation(operationData) {
    if (MOCK_MODE) {
      console.log('Моковая операция:', operationData);
      return Promise.resolve({ status: 'success' });
    }
    const token = getToken();
    if (!token) {
      console.error("Токен не найден");
      window.location.href = 'enter.html';
      return Promise.reject('Token not found');
    }

    console.log("Отправка запроса с токеном:", token);

    return $.ajax({
      url: `${API_BASE_URL}/transaction`,
      type: 'POST',
      contentType: 'application/json',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      data: JSON.stringify(operationData)
    });
  }

  function updateBalance(balance) {
    if (!balance || balance.amount === undefined) {
      console.error('Некорректные данные баланса:', balance);
      $('#balanceAmount').text('Ошибка данных').removeClass('balance-positive balance-negative');
      return;
    }

    try {
      const formattedAmount = new Intl.NumberFormat('ru-RU', {
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(balance.amount);

      const $balanceElement = $('#balanceAmount');
      $balanceElement.text(`${formattedAmount} ₽`);

      // Удаляем все цветовые классы и добавляем нужный
      $balanceElement
              .removeClass('balance-positive balance-negative')
              .addClass(balance.amount >= 0 ? 'balance-positive' : 'balance-negative');

    } catch (e) {
      console.error('Ошибка форматирования баланса:', e);
      $('#balanceAmount')
              .text(`${balance.amount} ₽`)
              .removeClass('balance-positive balance-negative')
              .addClass(balance.amount >= 0 ? 'balance-positive' : 'balance-negative');
    }
  }


  // Обработчики событий
  function setupEventListeners() {
    // Открытие модального окна
    $('#addOperationBtn').click(function() {
      $('#operationModal').show();
      loadCategories($('.tab.active').data('tab'));
    });

    // Закрытие модального окна
    $('.close, #operationModal').click(function(e) {
      if (e.target === this || $(e.target).hasClass('close')) {
        $('#operationModal').hide();
      }
    });

    // Переключение вкладок
    $('.tab').click(function() {
      $('.tab').removeClass('active');
      $(this).addClass('active');
      loadCategories($(this).data('tab'));
    });

    // Отправка операции
    $('#submitOperation').click(handleOperationSubmit);

    // Переключение периодов
    $('.pie-period-btn').click(function() {
      const period = $(this).data('period');
      $('.pie-period-btn').removeClass('active');
      $(this).addClass('active');
      updateCharts(period);
    });
  }

  function loadCategories(type) {
    $('#modalCategories').html('<div class="loading-message">Загрузка категорий...</div>');

    fetchCategories(type).then(function(categories) {
      showCategories(categories);
    }).catch(function(error) {
      console.error('Ошибка загрузки категорий:', error);
      $('#modalCategories').html('<div class="error-message">Не удалось загрузить категории</div>');
      if (MOCK_MODE) {
        showCategories(MOCK_DATA.categories[type]);
      }
    });
  }

  function showCategories(categories) {
    if (!categories || categories.length === 0) {
      $('#modalCategories').html('<div class="error-message">Категории не найдены</div>');
      return;
    }

    let html = '';
    categories.forEach(cat => {
      html += `
        <div class="modal-category" data-id="${cat.id}">
          <div class="category-circle" style="background-color: ${cat.color || '#ccc'}"></div>
          ${cat.name}
        </div>
      `;
    });
    $('#modalCategories').html(html);

    $('.modal-category').click(function() {
      $('.modal-category').removeClass('selected');
      $(this).addClass('selected');
    });
  }

  function updateCharts(period) {
    // Обновляем данные графиков для выбранного периода
    const stats = MOCK_DATA.statistics[period];

    // Комбинированный график
    if (period === 'month') {
      AppState.charts.combined.data.labels = stats.combined.labels;
      AppState.charts.combined.data.datasets[0].data = stats.combined.income;
      AppState.charts.combined.data.datasets[1].data = stats.combined.expense;
      AppState.charts.combined.update();
    }

    // Доходы
    AppState.charts.income.data.labels = stats.income.labels;
    AppState.charts.income.data.datasets[0].data = stats.income.data;
    AppState.charts.income.data.datasets[0].backgroundColor = stats.income.colors;
    AppState.charts.income.update();

    // Расходы
    AppState.charts.expense.data.labels = stats.expense.labels;
    AppState.charts.expense.data.datasets[0].data = stats.expense.data;
    AppState.charts.expense.data.datasets[0].backgroundColor = stats.expense.colors;
    AppState.charts.expense.update();
  }

  function handleOperationSubmit() {
    const amount = parseFloat($('#operationAmount').val());
    const type = $('.tab.active').data('tab');
    const categoryId = $('.modal-category.selected').data('id');

    if (!validateOperation(amount, categoryId)) return;

    const operationData = {
      amount: amount,
      transactionType: type.toUpperCase(),
      categoryId: categoryId
    };

    postOperation(operationData).then(function() {
      $('#operationModal').hide();
      if (!MOCK_MODE) {
        loadData(); // Обновляем данные с сервера
      }
    }).catch(function() {
      console.error('Ошибка при добавлении операции');
    });
  }

  function validateOperation(amount, categoryId) {
    if (isNaN(amount) || amount <= 0) {
      alert('Введите корректную сумму');
      return false;
    }
    if (!categoryId) {
      alert('Выберите категорию');
      return false;
    }
    return true;
  }
  // Функция для выхода из системы
  function logout() {
    // Удаляем куку с токеном
    document.cookie = 'USER_JWT=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; Secure; SameSite=Strict';

    // Перенаправляем на страницу входа
    window.location.href = 'main.html';
  }

</script>
</body>
</html>