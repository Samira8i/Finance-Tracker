<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>История операций | Трекер финансов</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="../static/style_history.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<!-- Боковое меню -->
<div class="side-menu">
    <div class="menu-item" title="Добавить операцию" id="addOperationBtn">
        <img src="../media/plus.png" alt="" />
    </div>
    <a href="index.html" class="menu-item" title="Дом">
        <img src="../media/home.png" alt="" />
    </a>
    <a href="#" class="menu-item active" title="История">
        <img src="../media/history.png" alt="" />
    </a>
    <a href="main.html" class="menu-item" title="Выход">
        <img src="../media/exit.png" alt="" />
    </a>
</div>

<div class="container">
    <!-- Основной контент -->
    <div class="content">
        <div class="history-header">
            <h1 class="history-title">История операций</h1>
        </div>

        <!-- История операций -->
        <div class="operations-container" id="operationsContainer">
            <!-- Операции будут загружаться динамически -->
        </div>
    </div>

    <!-- Фильтрация в стиле модального окна -->
    <div class="filters-sidebar">
        <h2 class="filters-title">Фильтрация</h2>

        <div class="filter-tabs">
            <div class="filter-tab active" data-filter-tab="income">Доход</div>
            <div class="filter-tab" data-filter-tab="expense">Расход</div>
        </div>

        <div class="filter-categories" id="filterCategories">
            <!-- Категории будут загружены динамически -->
        </div>

        <div class="filter-buttons">
            <button class="filter-btn apply">Применить</button>
            <button class="filter-btn reset">Сбросить</button>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления операций -->
<div class="modal" id="operationModal" style="display:none;">
    <div class="modal-content">
        <span class="close" style="cursor:pointer;">&times;</span>

        <div class="tabs">
            <div class="tab" data-tab="income">Доход</div>
            <div class="tab active" data-tab="expense">Расход</div>
        </div>

        <input type="number" class="amount-input" id="operationAmount" placeholder="Введите сумму" />

        <div class="modal-categories" id="modalCategories">
            <!-- Категории будут подгружаться -->
        </div>

        <button class="submit-btn" id="submitOperation">Отправить</button>
    </div>
</div>

<script>
    const MOCK_DATA = {
        categories: {
            income: [
                {id: 1, name: "Вклад", amount: 45000, color: "#FFF8A5"},
                {id: 2, name: "Бизнес", amount: 32000, color: "#A7BDEE"},
                {id: 3, name: "Зарплата", amount: 120000, color: "#81E472"},
                {id: 4, name: "Аренда", amount: 25000, color: "#D6A7EE"},
                {id: 5, name: "Криптовалюта", amount: 8500, color: "#EEA7A8"},
                {id: 6, name: "Другое", amount: 5200, color: "#4C5BCF"}
            ],
            expense: [
                {id: 101, name: "Дом", amount: 35000, color: "#E2A7EE"},
                {id: 102, name: "Продукты", amount: 18000, color: "#B3EEA7"},
                {id: 103, name: "Хобби", amount: 12000, color: "#EEA7A8"},
                {id: 104, name: "Кафе", amount: 8500, color: "#EEC6A7"},
                {id: 105, name: "Здоровье", amount: 6200, color: "#A7ECEE"},
                {id: 106, name: "Другое", amount: 4300, color: "#EEEDA7"}
            ]
        }
    };

    const API_BASE_URL = 'http://localhost:8080/api/v1';
    const MOCK_MODE = true;

    function getJwtToken() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'USER_JWT') {
                return value;
            }
        }
        return null;
    }

    $.ajaxSetup({
        beforeSend: function(xhr) {
            const token = getJwtToken();
            if (token) {
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
            }
        }
    });

    function groupByDate(operations) {
        return operations.reduce((acc, op) => {
            const date = op.transactionDate.split('T')[0];
            if (!acc[date]) acc[date] = [];
            acc[date].push(op);
            return acc;
        }, {});
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { day: 'numeric', month: 'long' };
        return date.toLocaleDateString('ru-RU', options);
    }

    function displayGroupedOperations(groupedData) {
        const $container = $('#operationsContainer');
        $container.empty();

        if (!groupedData || Object.keys(groupedData).length === 0) {
            $container.append('<div class="no-data">Нет операций для отображения</div>');
            return;
        }

        Object.keys(groupedData)
            .sort((a, b) => new Date(b) - new Date(a))
            .forEach(date => {
                const dateElement = $(`<div class="operations-date">${formatDate(date)}</div>`);
                const dayContainer = $('<div class="operations-day">').append(dateElement);

                groupedData[date].forEach(op => {
                    const type = op.transactionType.toLowerCase();
                    const amountClass = type === 'income' ? 'income' : 'expense';
                    const amountSign = type === 'income' ? '+' : '-';

                    // Здесь можно заменить categoryId на название категории, если есть данные
                    let categoryName = op.categoryName || op.categoryId || 'Другое';

                    dayContainer.append(`
                        <div class="operation-item" data-id="${op.id}">
                            <span class="operation-category">${categoryName}</span>
                            <span class="operation-amount ${amountClass}">${amountSign}${op.amount.toLocaleString('ru-RU')} руб</span>
                        </div>
                    `);
                });

                $container.append(dayContainer);
            });
    }

    // Загрузка категорий для фильтра и модального окна
    function fetchCategories(type) {
        const typeParam = type.toLowerCase(); // исправлено, чтобы передавать lower case
        if (MOCK_MODE) return Promise.resolve(MOCK_DATA.categories[typeParam]);
        return $.get(`${API_BASE_URL}/categories?categoryType=${typeParam}`).then(response => response);
    }

    function showCategoriesInModal(categories) {
        if (!categories || categories.length === 0) {
            $('#modalCategories').html('<div class="error-message">Категории не найдены</div>');
            return;
        }

        let html = '';
        categories.forEach(cat => {
            html += `
            <div class="modal-category" data-id="${cat.id}">
              <div class="category-circle" style="background-color: ${cat.color || '#ccc'}"></div>
              ${cat.name}
            </div>
          `;
        });
        $('#modalCategories').html(html);

        $('.modal-category').click(function() {
            $('.modal-category').removeClass('selected');
            $(this).addClass('selected');
        });
    }

    // Отображение категорий для фильтра
    function showCategoriesInFilter(categories) {
        if (!categories || categories.length === 0) {
            $('#filterCategories').html('<div class="error-message">Категории не найдены</div>');
            return;
        }

        let html = '';
        categories.forEach(cat => {
            html += `
            <div class="filter-category" data-id="${cat.id}" style="cursor:pointer;">
                <div class="category-circle" style="background-color: ${cat.color || '#ccc'}"></div>
                ${cat.name}
            </div>
            `;
        });
        $('#filterCategories').html(html);

        // Обработчик выбора категории фильтра
        $('.filter-category').click(function() {
            $(this).toggleClass('selected');
        });
    }

    async function updateFilterUI() {
        const type = $('.filter-tab.active').data('filter-tab');
        $('#filterCategories').html('<div class="loading-message">Загрузка категорий...</div>');

        try {
            const categories = await fetchCategories(type);
            showCategoriesInFilter(categories);
        } catch (error) {
            console.error('Ошибка загрузки категорий для фильтра:', error);
            $('#filterCategories').html('<div class="error-message">Не удалось загрузить категории</div>');
            if (MOCK_MODE) {
                showCategoriesInFilter(MOCK_DATA.categories[type]);
            }
        }
    }

    async function updateModalCategories(type) {
        $('#modalCategories').html('<div class="loading-message">Загрузка категорий...</div>');
        try {
            const categories = await fetchCategories(type.toLowerCase());
            showCategoriesInModal(categories);
        } catch (error) {
            console.error('Ошибка загрузки категорий для модального окна:', error);
            $('#modalCategories').html('<div class="error-message">Не удалось загрузить категории</div>');
            if (MOCK_MODE) {
                showCategoriesInModal(MOCK_DATA.categories[type.toLowerCase()]);
            }
        }
    }

    async function loadOperations() {
        try {
            const type = $('.filter-tab.active').data('filter-tab').toUpperCase();
            const selectedCategories = $('.filter-category.selected').map((i, el) => $(el).data('id')).get();

            let url = `${API_BASE_URL}/transaction/history?type=${type}`;
            if (selectedCategories.length > 0) {
                url += `&categories=${selectedCategories.join(',')}`;
            }

            const response = await $.get(url);
            const grouped = groupByDate(response);
            displayGroupedOperations(grouped);
        } catch (error) {
            console.error('Ошибка загрузки операций:', error);
            if (error.status === 403) {
                alert('Сессия истекла. Пожалуйста, войдите снова.');
                window.location.href = 'enter.html';
            } else {
                $('#operationsContainer').html('<div class="error-message">Ошибка загрузки данных</div>');
            }
        }
    }

    function validateOperation(amount, categoryId) {
        if (isNaN(amount) || amount <= 0) {
            alert('Введите корректную сумму (больше 0)');
            return false;
        }
        if (!categoryId) {
            alert('Выберите категорию');
            return false;
        }
        return true;
    }

    $(document).ready(function() {
        if (!getJwtToken()) {
            alert('Пожалуйста, авторизуйтесь');
            window.location.href = 'enter.html';
            return;
        }

        loadOperations();
        updateFilterUI();

        $('.filter-tab').click(async function() {
            $('.filter-tab').removeClass('active');
            $(this).addClass('active');
            await updateFilterUI();
            loadOperations();
        });

        $('.filter-btn.apply').click(loadOperations);

        $('.filter-btn.reset').click(function() {
            $('.filter-category').removeClass('selected');
            loadOperations();
        });

        $('#addOperationBtn').click(function() {
            $('#operationModal').show();
            const type = $('.tab.active').data('tab').toUpperCase();
            updateModalCategories(type);
        });

        // Закрытие модального окна при клике на крестик или на фон (только если клик по самому фону)
        $('.close').click(() => $('#operationModal').hide());
        $('#operationModal').click(function(e) {
            if (e.target === this) {
                $('#operationModal').hide();
            }
        });

        $('.tab').click(function() {
            $('.tab').removeClass('active');
            $(this).addClass('active');
            const type = $(this).data('tab').toUpperCase();
            updateModalCategories(type);
        });

        $('#submitOperation').click(async function() {
            const amount = parseFloat($('#operationAmount').val());
            const type = $('.tab.active').data('tab').toUpperCase();
            const categoryId = $('.modal-category.selected').data('id');

            if (!validateOperation(amount, categoryId)) return;

            try {
                await $.ajax({
                    url: `${API_BASE_URL}/transaction`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        amount: amount,
                        transactionType: type,
                        categoryId: categoryId
                    })
                });

                $('#operationModal').hide();
                $('#operationAmount').val('');
                $('.modal-category.selected').removeClass('selected');
                loadOperations();
            } catch (error) {
                console.error('Ошибка при добавлении операции:', error);
                if (error.status === 403) {
                    alert('Сессия истекла. Пожалуйста, войдите снова.');
                    window.location.href = 'enter.html';
                } else {
                    alert('Не удалось добавить операцию: ' + (error.responseJSON?.message || error.statusText || 'Ошибка'));
                }
            }
        });
    });
</script>
</body>
</html>
